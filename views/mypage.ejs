<%- include('header') %>
<div class="mypage">
  <h2>마이페이지</h2>

  <div class="section">
    <div class="mypage-profile">
      <h3><%= user.nickname %>님</h3>
      <p style="color:var(--text-sub)"><%= user.email || '' %></p>
      <p class="mypage-type">
        <% if (user.kakao_id) { %>
          <span class="badge badge-kakao">카카오 연동</span> 보상 대기 7일
        <% } else { %>
          <span class="badge badge-normal">일반회원</span> 보상 대기 30일
        <% } %>
      </p>
      <% if (!user.kakao_id) { %>
        <a href="/auth/kakao/link" class="btn btn-kakao" style="margin-top:8px">카카오 연동하면 7일로 단축!</a>
      <% } %>
    </div>
  </div>

  <!-- 연속 구매 스트릭 -->
  <div class="streak-card">
    <h3>
      <% if (streak.current_streak > 0) { %>
        🔥 연속 구매 <%= streak.current_streak %>일째!
      <% } else { %>
        🔥 연속 구매 도전!
      <% } %>
    </h3>
    <div class="streak-dots">
      <% for (var i = 1; i <= 5; i++) { %>
        <div class="streak-dot <%= i <= streak.current_streak ? 'filled' : 'empty' %>">
          <%= i <= streak.current_streak ? '✓' : i %>
        </div>
      <% } %>
    </div>
    <p>
      <span class="streak-bonus">5일 달성 시 보너스 티켓!</span>
      <% if (streak.longest_streak > 0) { %>
        <br><span style="font-size:11px;color:var(--text-muted)">최장 기록: <%= streak.longest_streak %>일</span>
      <% } %>
    </p>
  </div>

  <div class="stats-grid">
    <div class="stat-card balance">
      <h3>내 잔액</h3>
      <p class="stat-value"><%= Number(user.balance).toLocaleString() %>원</p>
    </div>
    <div class="stat-card">
      <h3>복권</h3>
      <p class="stat-value"><%= unusedLottery %>장</p>
      <% if (unusedLottery > 0) { %>
        <a href="/tickets" class="btn btn-sm">사용</a>
      <% } %>
    </div>
    <div class="stat-card">
      <h3>룰렛</h3>
      <p class="stat-value"><%= unusedRoulette %>장</p>
      <% if (unusedRoulette > 0) { %>
        <a href="/tickets" class="btn btn-sm">사용</a>
      <% } %>
    </div>
    <div class="stat-card">
      <h3>교환가능</h3>
      <p class="stat-value"><%= Number(availableRewards.total).toLocaleString() %>원</p>
      <% if (availableRewards.count > 0) { %>
        <a href="/rewards" class="btn btn-sm">교환</a>
      <% } %>
    </div>
    <div class="stat-card">
      <h3>대기중</h3>
      <p class="stat-value"><%= Number(pendingRewards.total).toLocaleString() %>원</p>
    </div>
    <div class="stat-card">
      <h3>오늘한도</h3>
      <p class="stat-value"><%= Number(dailyLimit.remaining).toLocaleString() %>원</p>
    </div>
  </div>

  <!-- 이달의 절약왕 랭킹 -->
  <div class="ranking-card">
    <h3>🏆 이달의 절약왕</h3>
    <% if (rankings.length === 0) { %>
      <p class="empty">이번 달 교환 내역이 없습니다.</p>
    <% } else { %>
      <% var medals = ['🥇','🥈','🥉']; %>
      <% rankings.forEach(function(r, idx) { %>
        <div class="ranking-item <%= r.id === user.id ? 'me' : '' %>">
          <% if (idx < 3) { %>
            <span class="ranking-medal"><%= medals[idx] %></span>
          <% } else { %>
            <span class="ranking-rank"><%= idx + 1 %></span>
          <% } %>
          <span class="ranking-name">
            <%= r.nickname %><%= r.id === user.id ? ' ← 나' : '' %>
          </span>
          <span class="ranking-amount"><%= Number(r.total).toLocaleString() %>원</span>
        </div>
      <% }); %>
      <% var inTop10 = rankings.some(function(r) { return r.id === user.id; }); %>
      <% if (!inTop10 && myTotal > 0) { %>
        <hr class="ranking-divider">
        <div class="ranking-item me">
          <span class="ranking-rank"><%= myRank %></span>
          <span class="ranking-name"><%= user.nickname %> ← 나</span>
          <span class="ranking-amount"><%= Number(myTotal).toLocaleString() %>원</span>
        </div>
      <% } %>
    <% } %>
  </div>

  <div class="section">
    <h3>최근 구매</h3>
    <% if (recentPurchases.length === 0) { %>
      <p class="empty">아직 구매 내역이 없습니다.</p>
    <% } %>
    <div class="purchase-list">
      <% recentPurchases.forEach(function(p) { %>
        <div class="purchase-item">
          <span class="purchase-name"><%= p.product_name || '상품' %></span>
          <span class="purchase-amount"><%= Number(p.amount).toLocaleString() %>원</span>
        </div>
      <% }); %>
    </div>
  </div>

  <div class="section">
    <table class="reward-table">
      <tr><td>티켓 당첨 누적</td><td><%= Number(ticketTotal).toLocaleString() %>원</td></tr>
      <tr><td>보상 대기일</td><td><%= user.reward_delay_days %>일</td></tr>
    </table>
  </div>

  <div style="text-align:center;margin-top:20px">
    <a href="/auth/logout" class="btn btn-outline">로그아웃</a>
  </div>
</div>
<%- include('footer') %>
